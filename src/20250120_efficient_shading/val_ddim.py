# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96433 -m interpolate_copyroom10 -c 10
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96433 -m interpolate_copyroom10_static -c 10
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m interpolate_copyroom10_static -c 0
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 1
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 2
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96433 -m all_copyroom10 -c 20
# 
#96458 96461 96462
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 1,2,3,4,5
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 6,7,8,9,10

# all_everett_dining1

# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_copyroom10 -c 1,2,3,4,5
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_copyroom10 -c 6,7,8,9,10
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_copyroom10 -c 11,12,13,14,15
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_copyroom10 -c 16,17,18,19,20 

# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96453 -m all_copyroom10 -c 1,2,3,4,5
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96453 -m all_copyroom10 -c 6,7,8,9,10
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96453 -m all_copyroom10 -c 11,12,13,14,15
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96453 -m all_copyroom10 -c 16,17,18,19,20 


# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 11,12,13
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 14,15
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 16,17,18
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96458 -m all_copyroom10 -c 19,20


# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 11,12,13
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 14,15
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 16,17,18
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 19,20

# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 1,2,3,4,5
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 6,7,8,9,10
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 11,12,13,14,15
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 96434 -m all_everett_dining1 -c 16,17,18,19

#bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97227 -m all_copyroom10 -c 45
#bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97227 -m all_copyroom10_light3 -c 38
#bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97226 -m all_copyroom10_light3 -c 38

# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97636 -m interpolate_copyroom10_ordinal_shading -c 12 
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97637 -m interpolate_copyroom10_ordinal_shading -c 12 
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97638 -m interpolate_copyroom10_ordinal_shading -c 12 

# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97636 -m all_everett_dining1 -c 12,11,10,9,8,7,6,5,4,3,2,1
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97637 -m all_everett_dining1 -c 12,11,10,9,8,7,6,5,4,3,2,1 
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97638 -m all_everett_dining1 -c 12,11,10,9,8,7,6,5,4,3,2,1 

# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97227 -m all_everett_dining1,interpolate_copyroom10 -c 45
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97623 -m all_everett_dining1,interpolate_copyroom10 -c 45
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97624 -m all_everett_dining1,interpolate_copyroom10 -c 45
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97625 -m all_everett_dining1,interpolate_copyroom10 -c 45
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97626 -m all_everett_dining1,interpolate_copyroom10 -c 45
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97622 -m all_everett_dining1,interpolate_copyroom10 -c 83


# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97638 -m all_everett_dining1_ordinal_shading -c 13,12,11,10,9,8,7,6,5,4,3,2,1 
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 97638 -m all_everett_dining1_ordinal_shading -c 1,2,3,4,5,6,7,8,9,10


# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 98316 -m all_everett_dining1_ordinal_shading -c 28,27,26,25,24,23,22,21,20,19,18,17,16,15,14
# bin/siatv100 src/20250120_efficient_shading/val_ddim.py -i 98316 -m interpolate_copyroom10_ordinal_shading -c 28,27,26,25,24,23,22,21,20,19,18,17,16,15,14



# version_97638

import os
import lightning as L
import torch
import argparse 
#from LineNotify import LineNotify
import argparse
from constants import FOLDER_NAME

from constants import OUTPUT_MULTI, DATASET_ROOT_DIR, DATASET_VAL_DIR, DATASET_VAL_SPLIT
from sddiffusionface import SDDiffusionFace, ScrathSDDiffusionFace, SDWithoutAdagnDiffusionFace, SDOnlyAdagnDiffusionFace, SDOnlyShading, SDDiffusionFaceNoShading, SDDiffusionFace5ch, SDDiffusionFaceNoBg

from datasets.DDIMDiffusionFaceRelightDataset import DDIMDiffusionFaceRelightDataset

MASTER_TYPE = 16
CHECKPOINT_FOLDER_NAME = "20250120_efficient_shading"


parser = argparse.ArgumentParser()
parser.add_argument("-i", "--version", type=str, default="2")
parser.add_argument("-m", "--mode", type=str, default="face_left,face_right")
parser.add_argument("-g", "--guidance_scale", type=str, default="1")
parser.add_argument("-c", "--checkpoint", type=str, default="lastest")

args = parser.parse_args()

# we validate 4  model whcih are 
# all
# scrath
# controlnet (SD without adagan)
# adagan


NAMES = {
    96433: 'vae_shcoeff_1scene',
    96434: 'clip_multiscene',
    96453: 'clip_multiscene',
    96458: 'clip_1scene',
    96461: 'clip_1scene',
    96462: 'clip_1scene',
    97227: 'v5_clip_multiscene',
    97226: 'v5_clip_100scene',
    97225: 'v5_clip_50scene',
    97224: 'v5_clip_20scene',
    97223: 'v5_clip_10scene',
    97222: 'v5_clip_5scene',
    97221: 'v5_clip_1scene',
    97622: 'v5_clip_multiscene',
    97623: 'v5_clip_multiscene',
    97624: 'v5_clip_multiscene',
    97625: 'v5_clip_multiscene',
    97626: 'v5_clip_multiscene',
    97636: 'ordinal_shading',
    97637: 'oldshading_with_albedo',
    97638: 'offshelf_onlyshading',
    98316: 'offshelf_onlyshading'
}
METHODS = {
    96433: 'default',
    96434: 'default',
    96453: 'default',
    96458: 'default',
    96461: 'default',
    96462: 'default',
    97227: 'default',
    97226: 'default',
    97225: 'default',
    97224: 'default',
    97223: 'default',
    97222: 'default',
    97221: 'default',
    97622: 'default',
    97623: 'default',
    97624: 'default',
    97625: 'default',
    97626: 'default',
    97636: 'default',
    97637: 'default',
    97638: 'default',
    98316: 'default',
}
CONDITIONS_CLASS = {
    96433: SDDiffusionFaceNoBg,
    96434: SDDiffusionFaceNoBg,
    96453: SDDiffusionFaceNoBg,
    96458: SDDiffusionFaceNoBg,
    96461: SDDiffusionFaceNoBg,
    96462: SDDiffusionFaceNoBg,
    97227: SDDiffusionFaceNoBg,
    97226: SDDiffusionFaceNoBg,
    97225: SDDiffusionFaceNoBg,
    97224: SDDiffusionFaceNoBg,
    97223: SDDiffusionFaceNoBg,
    97222: SDDiffusionFaceNoBg,
    97221: SDDiffusionFaceNoBg,
    97622: SDDiffusionFaceNoBg,
    97623: SDDiffusionFaceNoBg,
    97624: SDDiffusionFaceNoBg,
    97625: SDDiffusionFaceNoBg,
    97626: SDDiffusionFaceNoBg,
    97636: SDDiffusionFace,
    97637: SDDiffusionFace,
    97638: SDDiffusionFaceNoBg,
    98316: SDDiffusionFaceNoBg,
}
LRS = {
    96433: '1e-4',
    96434: '1e-4',
    96453: '1e-4',
    96458: '1e-4',
    96461: '1e-5',
    96462: '1e-6',
    97227: '1e-4',
    97226: '1e-4',
    97225: '1e-4',
    97224: '1e-4',
    97223: '1e-4',
    97222: '1e-4',
    97221: '1e-4',
    97622: '1e-4',
    97623: '5e-5',
    97624: '1e-5',
    97625: '5e-6',
    97626: '1e-6',   
    97636: '1e-4',
    97637: '1e-4',
    97638: '1e-4',
    98316: '1e-4',
}
DIRNAME = {
    96433: CHECKPOINT_FOLDER_NAME,
    96434: CHECKPOINT_FOLDER_NAME,
    96453: CHECKPOINT_FOLDER_NAME,
    96458: CHECKPOINT_FOLDER_NAME,
    96461: CHECKPOINT_FOLDER_NAME,
    96462: CHECKPOINT_FOLDER_NAME,
    97227: CHECKPOINT_FOLDER_NAME,
    97226: CHECKPOINT_FOLDER_NAME,
    97225: CHECKPOINT_FOLDER_NAME,
    97224: CHECKPOINT_FOLDER_NAME,
    97223: CHECKPOINT_FOLDER_NAME,
    97222: CHECKPOINT_FOLDER_NAME,
    97221: CHECKPOINT_FOLDER_NAME,
    97622: CHECKPOINT_FOLDER_NAME,
    97623: CHECKPOINT_FOLDER_NAME,
    97624: CHECKPOINT_FOLDER_NAME,
    97625: CHECKPOINT_FOLDER_NAME,
    97626: CHECKPOINT_FOLDER_NAME,
    97636: CHECKPOINT_FOLDER_NAME,
    97637: CHECKPOINT_FOLDER_NAME,
    97638: CHECKPOINT_FOLDER_NAME,
    98316: CHECKPOINT_FOLDER_NAME,
}
CHECKPOINTS = {
    96433: 10,
    96434: 10,
    96453: 10,
    96458: 0,
    96461: 10,
    96462: 10,
    97227: 38,
    97226: 38,
    97225: 38,
    97224: 38,
    97223: 38,
    97222: 38,
    97221: 38,
    97622: 83,
    97623: 45,
    97624: 45,
    97625: 45,
    97626: 45,
    97636: 13,
    97637: 13,
    97638: 13,
    98316: 13,
}

use_ab_background = []
use_shcoeff2 = [96433]
use_only_light = [96433]
use_no_light = [96458, 96461, 96462, 96434, 96453, 97227, 97636, 97637, 97638, 97221, 97222, 97223, 97224, 97225, 97226, 97622, 97623, 97624, 97625, 97626]
use_random_mask_background = []

def get_from_mode(mode):
    if mode == "rotate_copyroom10":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_copyroom10", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "control_shading_from_ldr27coeff", "feature_types": []},  "a photorealistic image"
    if mode == "rotate_copyroom10_balance":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_copyroom10", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "control_shading_from_ldr27coeff_balance", "feature_types": []},  "a photorealistic image"
    if mode == "rotate_copyroom10_left_balance":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_copyroom10_left", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "control_shading_from_ldr27coeff_balance", "feature_types": []},  "a photorealistic image"
    if mode == "rotate_copyroom10_left":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_copyroom10_left", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "control_shading_from_ldr27coeff", "feature_types": []},  "a photorealistic image"
    if mode == "rotate_everett_kitchen4_left":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_everett_kitchen4_left", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_kitchen4_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "control_shading_from_ldr27coeff", "feature_types": []},  "a photorealistic image"
    if mode == "rotate_everett_kitchen4_right":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_everett_kitchen4_right", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_kitchen4_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "control_shading_from_ldr27coeff", "feature_types": []},  "a photorealistic image"
    if mode == "rotate_copyroom10_right_conv_v2":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_copyroom10", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "rotate_copyroom10_light0_conv_v2":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_copyroom10_light0", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "interpolate_copyroom10":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_interpolate_copyroom10", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "interpolate_copyroom10_static":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_interpolate_copyroom10_static", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "interpolate_copyroom10_ordinal_shading":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_interpolate_copyroom10", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_intrinsic_shading_diffuse", "backgrounds_dir": "control_intrinsic_albedo_shared", "feature_types": []},  "a photorealistic image"
    if mode == "all_copyroom10":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_copyroom10_light3":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light3.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_everett_dining1":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all.json", "shadings_dir": "control_shading_from_hdr27coeff_conv_v5", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_everett_dining1_ordinal_shading":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all.json", "shadings_dir": "control_intrinsic_shading_diffuse", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    else:
        raise Exception("mode not found")

def main():
    print("STARTING VALIDATION...")
    versions = [int(a.strip()) for a in args.version.split(",")]
    guidance_scales = [float(a.strip()) for a in args.guidance_scale.split(",")]
    #checkpoints = [int(a.strip()) for a in args.checkpoint.split(",")]
    checkpoints = []
    for checkpoint in args.checkpoint.split(","):
        checkpoint = checkpoint.strip()
        try:
            checkpoint = int(checkpoint)
        except:
            pass 
        checkpoints.append(checkpoint)
    modes = [a.strip() for a in args.mode.split(",")]

    print("version: ", versions)
    print("guidance_scales: ", guidance_scales)
    print("checkpoints: ", checkpoints)
    print("modes: ", modes)

    for mode in modes:
        for version in versions:
                ddim_class = CONDITIONS_CLASS[version]
                try:
                    for checkpoint in checkpoints:
                        dirname = DIRNAME[version]
                        if checkpoint == "lastest":
                            checkpoint = CHECKPOINTS[version]
                        if checkpoint == 0:
                            model = ddim_class(learning_rate=1e-4)
                            CKPT_PATH = None
                        else:
                            CKPT_PATH = f"output/{dirname}/multi_mlp_fit/lightning_logs/version_{version}/checkpoints/epoch={checkpoint:06d}.ckpt"
                            if not os.path.exists(CKPT_PATH):
                                print(f"Checkpoint not found: {CKPT_PATH}")
                                continue
                            model = ddim_class.load_from_checkpoint(CKPT_PATH)
                        # disable chromeball inpaint if exist
                        if hasattr(model, 'pipe_chromeball'):
                            del model.pipe_chromeball
                        model.eval() # disable randomness, dropout, etc...
                        model.disable_plot_train_loss()
                        for guidance_scale in guidance_scales:
                            model.set_guidance_scale(guidance_scale)                        
                            output_dir = f"output/{FOLDER_NAME}/val_{mode}/{METHODS[version]}/{guidance_scale}/{NAMES[version]}/{LRS[version]}/chk{checkpoint}/"
                            # skip if output dir exist 
                            if os.path.exists(output_dir):
                                print(f"Skip {output_dir}")
                                continue
                            os.makedirs(output_dir, exist_ok=True)
                            print("================================")
                            print(output_dir)
                            print("================================")
                            trainer = L.Trainer(max_epochs=1000, precision=MASTER_TYPE, check_val_every_n_epoch=1, default_root_dir=output_dir, inference_mode=False, gradient_clip_val=0)
                            val_root, count_file, dataset_class, dataset_args, specific_prompt = get_from_mode(mode)
                            if type(count_file) == int:
                                split = slice(0, count_file, 1)
                            else:
                                split = count_file
                            if version in use_shcoeff2:
                                dataset_args['use_shcoeff2'] = True
                            if version in use_only_light:
                                dataset_args['feature_types'] = ['light']
                            if version in use_no_light:
                                dataset_args['feature_types'] = []
                            val_dataset = dataset_class(split=split, root_dir=val_root, specific_prompt=specific_prompt, **dataset_args)
                            val_dataloader = torch.utils.data.DataLoader(val_dataset, batch_size=1, shuffle=False)
                            trainer.test(model, dataloaders=val_dataloader, ckpt_path=CKPT_PATH)


                except Exception as e:
                    raise e

                                
if __name__ == "__main__":
    main()