# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99826 -m v2_all_everett_dining1_exr_oldgt -c 50,40,30,20,10,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99828 -m v2_all_everett_dining1_exr_newgt -c 50,40,30,20,10,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99998 -m v2_all_everett_dining1_divide -c 50,40,30,20,10,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99828 -m v3_all_14n_copyroom10_light_from_albedo_newgt -c 50,40,30,20,10,1,5,15,25,35,45
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99828 -m v3_all_14n_copyroom10_light_from_albedo_oldgt -c 50,40,30,20,10,1,5,15,25,35,45


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99828 -m v3_all_14n_copyroom10_light_from_albedo_newgt -c 50,40,30,20,10,1,5,15,25,35,45
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99826 -m v3_all_everett_dining1_exr_oldgt -c 50,40,30,20,10,1,5,15,25,35,45


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99828 -m single_everett_dining1_exr_newgt -c 40

# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102510 -m v3_copyroom10_rotate_exr_newgt -c 197 



# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 100235 -m v3_all_14n_copyroom10_light0_exr_newgt -c 65,60,50,40,30,20,10,1,5,15,25,35,45,55
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 100235 -m v3_all_14n_copyroom10_light3_exr_newgt -c 65,60,50,40,30,20,10,1,5,15,25,35,45,55
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 100235 -m v3_all_14n_copyroom10_light4_exr_newgt -c 65,60,50,40,30,20,10,1,5,15,25,35,45,55
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 100235 -m v3_all_14n_copyroom10_light20_exr_newgt -c 65,60,50,40,30,20,10,1,5,15,25,35,45,55


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101578,101579,101580,101581 -m v3_all_14n_copyroom10_light0_exr_newgt -c 98
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101578,101579,101580,101581 -m v3_all_14n_copyroom10_light3_exr_newgt -c 98
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101578,101579,101580,101581 -m v3_all_14n_copyroom10_light4_exr_newgt -c 98
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101578,101579,101580,101581 -m v3_all_14n_copyroom10_light20_exr_newgt -c 98

# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101580 -m v3_all_14n_copyroom10_light0_exr_newgt,v3_all_14n_copyroom10_light3_exr_newgt,v3_all_14n_copyroom10_light4_exr_newgt,v3_all_14n_copyroom10_light20_exr_newgt -c 98
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101581 -m v3_all_14n_copyroom10_light0_exr_newgt,v3_all_14n_copyroom10_light3_exr_newgt,v3_all_14n_copyroom10_light4_exr_newgt,v3_all_14n_copyroom10_light20_exr_newgt -c 98
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101578,101579,101580,101581 -m v3_all_14n_copyroom10_light0_exr_newgt,v3_all_14n_copyroom10_light3_exr_newgt,v3_all_14n_copyroom10_light4_exr_newgt,v3_all_14n_copyroom10_light20_exr_newgt -c 98
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101578,101579,101580,101581 -m v3_all_everett_dining1_exr_newgt,v3_all_everett_dining1_light3_exr_newgt,v3_all_everett_dining1_light4_exr_newgt,v3_all_everett_dining1_light20_exr_newgt -c 98


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101761 -m v3_all_14n_copyroom10_light0_exr_newgt,v3_all_14n_copyroom10_light3_exr_newgt,v3_all_14n_copyroom10_light4_exr_newgt,v3_all_14n_copyroom10_light20_exr_newgt -c 72
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101761 -m v3_all_everett_dining1_exr_newgt,v3_all_everett_dining1_light3_exr_newgt,v3_all_everett_dining1_light4_exr_newgt,v3_all_everett_dining1_light20_exr_newgt -c 72


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102776 -m v3_all_14n_copyroom10_light0_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102777 -m v3_all_14n_copyroom10_light0_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102778 -m v3_all_14n_copyroom10_light0_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102773 -m v3_all_14n_copyroom10_light0_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102776 -m v3_all_14n_copyroom10_light3_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102777 -m v3_all_14n_copyroom10_light3_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102778 -m v3_all_14n_copyroom10_light3_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102773 -m v3_all_14n_copyroom10_light3_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177

# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102776 -m v3_all_14n_copyroom10_light4_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102777 -m v3_all_14n_copyroom10_light4_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102778 -m v3_all_14n_copyroom10_light4_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102773 -m v3_all_14n_copyroom10_light4_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102776 -m v3_all_14n_copyroom10_light20_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102777 -m v3_all_14n_copyroom10_light20_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102778 -m v3_all_14n_copyroom10_light20_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102773 -m v3_all_14n_copyroom10_light20_exr_newgt -c 150,151,152,153,154,155,156,157,158,159,160,161,162,163,164,165,166,167,168,169,170,171,172,173,174,175,176,177




# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102774 -m v3_all_14n_copyroom10_light0_exr_newgt -c 220,215,200,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102774 -m v3_all_14n_copyroom10_light3_exr_newgt -c 220,215,200,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102774 -m v3_all_14n_copyroom10_light4_exr_newgt -c 220,215,200,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102774 -m v3_all_14n_copyroom10_light20_exr_newgt -c 220,215,200,198,199,200,201,202,203,204,205,206,207,208,209,210,211,212,213,214,215,216,217,218,219,220,221,222,223,224


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 103212 -m v3_all_14n_copyroom10_light0_exr_newgt,v3_all_14n_copyroom10_light3_exr_newgt -c 225,226,227,228,229,230,231,232,233
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 103212 -m v3_all_14n_copyroom10_light4_exr_newgt,v3_all_14n_copyroom10_light20_exr_newgt -c 225,226,227,228,229,230,231,232,233




# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102427 -m face_spatial_guy329_single -c 21,22,23
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102771 -m valid_face_same -c 29
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102771 -m valid_face_different -c 29
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102771 -m valid2left -c 29
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 102771 -m valid2right -c 29


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 103288 -m valid_face_same -c 29
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 103288 -m valid_face_different -c 29



# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_all_14n_copyroom10_light0_exr_newgt -c 140,141,142,143,144,145,146
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_all_14n_copyroom10_light3_exr_newgt -c 140,141,142,143,144,145,146
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_all_14n_copyroom10_light4_exr_newgt -c 140,141,142,143,144,145,146
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_all_14n_copyroom10_light20_exr_newgt -c 140,141,142,143,144,145,146
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_all_everett_dining1_exr_newgt -c 140,141,142,143,144,145,146
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_shiftbrightness_to_middle_all_everett_dining1_light3_exr_newgt -c 125
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_all_everett_dining1_light4_exr_newgt -c 140,141,142,143,144,145,146
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 101150 -m v3_all_everett_dining1_light20_exr_newgt -c 140,141,142,143,144,145,146

# v3_all_everett_dining1_light20_exr_newgt

# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99998 -m all_14n_copyroom10_light3_divide -c 15,10,5,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99998 -m all_14n_copyroom10_light3_divide -c 15,10,5,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99998 -m all_14n_copyroom10_light3_divide -c 15,10,5,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25


# all_14n_copyroom10_light3_exr_newgt
# all_14n_copyroom10_light4_exr_newgt
# all_14n_copyroom10_light20_exr_newgt


# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99826 -m all_14n_copyroom1_exr_oldgt -c 40,30,20,10,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,34,35,36,37,38,39,40,41,42
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99828 -m all_14n_copyroom1_exr_newgt -c 40,30,20,10,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,34,35,36,37,38,39,40,41,42
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99998 -m all_14n_copyroom1_divide -c 15,10,5,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14

# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99826 -m all_everett_kitchen4_exr_oldgt -c 40,30,20,10,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,34,35,36,37,38,39,40,41,42
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99828 -m all_everett_kitchen4_exr_newgt -c 40,30,20,10,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,32,33,34,35,36,37,38,39,40,41,42
# bin/siatv100 src/20250221_optmized_shading_exr/val_ddim.py -i 99998 -m all_everett_kitchen4_divide -c 15,10,5,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14

# tensorboard --host 10.204.100.211 --port 8214 --logdir_spec=5e-5:version_101105,1e-5:version_101106,5e-6:version_101107,1e-6:version_101108,1e-4:version_99828,5e-5_2:version_101578,1e-5_2:version_101579,5e-6_2:version_101580,5e-6_2:version_101581,version_100430:1e-4_2
# tensorboard --host 10.204.100.211 --port 8214 --logdir_spec=5e-5:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101105/events.out.tfevents.1740975444.ist-gpu-01.216355.1,1e-5:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101106/events.out.tfevents.1740975383.ist-gpu-15.314924.1,5e-6:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101107/events.out.tfevents.1740975233.ist-gpu-05.105437.1,1e-6:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101108/events.out.tfevents.1740975361.ist-gpu-06.438705.1,1e-4:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_99828/events.out.tfevents.1740111600.ist-gpu-13.120325.1,5e-5_2:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101578/events.out.tfevents.1741332508.ist-gpu-09.354587.0,1e-5_2:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101579/events.out.tfevents.1741332516.ist-gpu-06.295451.0,5e-6_2:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101580/events.out.tfevents.1741332524.ist-gpu-07.323960.0,5e-6_2:/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_101581/epoch_0099,/ist/ist-share/vision/pakkapon/relight/sd-light-time/output/20250221_optmized_shading_exr/multi_mlp_fit/lightning_logs/version_100430/events.out.tfevents.1740492129.ist-gpu-10.49142.0:1e-4_2

import os
import lightning as L
import torch
import argparse 
import argparse
from constants import FOLDER_NAME

from constants import OUTPUT_MULTI, DATASET_ROOT_DIR, DATASET_VAL_DIR, DATASET_VAL_SPLIT
from sddiffusionface import SDDiffusionFace, ScrathSDDiffusionFace, SDWithoutAdagnDiffusionFace, SDOnlyAdagnDiffusionFace, SDOnlyShading, SDDiffusionFaceNoShading, SDDiffusionFace5ch, SDDiffusionFaceNoBg

from datasets.DDIMDiffusionFaceRelightDataset import DDIMDiffusionFaceRelightDataset

MASTER_TYPE = 16
CHECKPOINT_FOLDER_NAME = "20250221_optmized_shading_exr"


parser = argparse.ArgumentParser()
parser.add_argument("-i", "--version", type=str, default="2")
parser.add_argument("-m", "--mode", type=str, default="face_left,face_right")
parser.add_argument("-g", "--guidance_scale", type=str, default="1")
parser.add_argument("-c", "--checkpoint", type=str, default="lastest")

args = parser.parse_args()

# we validate 4  model whcih are 
# all
# scrath
# controlnet (SD without adagan)
# adagan


NAMES = {
    99826: 'newshading_oldgt',
    99828: 'newshading_newgt',
    99998: 'divideshading_oldgt',
    100430: 'newshading_newgt',
    100235: 'singlescene_newgt',
    101150: 'newshading_newgt',
    101578: 'newshading_newgt',
    101579: 'newshading_newgt',
    101580: 'newshading_newgt',
    101581: 'newshading_newgt',
    101761: 'singlescene_newgt',
    102272: 'newshading_newgt',
    102273: 'newshading_newgt',
    102274: 'newshading_newgt',
    102279: 'newshading_newgt',
    102510: 'newshading_newgt',
    102427: 'pil_resize',
    102771: 'pil_resize',
    102774: 'newshading_newgt',
    103212: 'newshading_newgt',
    102773: 'newshading_newgt', 
    102776: 'newshading_newgt', 
    102777: 'newshading_newgt', 
    102778: 'newshading_newgt',
    103288: 'sdface'
}
METHODS = {
    99826: 'default',
    99828: 'default',
    99998: 'default',
    100430: 'default',
    100235: 'default',
    101150: 'default',
    101578: 'default',
    101579: 'default',
    101580: 'default',
    101581: 'default',
    101761: 'default',
    102272: 'default',
    102273: 'default',
    102274: 'default',
    102279: 'default',
    102510: 'default',
    102427: 'default',
    102771: 'default',
    102774: 'default',
    103212: 'default',
    102773: 'default',
    102776: 'default',
    102777: 'default',
    102778: 'default',
    103288: 'default'
}
CONDITIONS_CLASS = {
    99826: SDDiffusionFaceNoBg,
    99828: SDDiffusionFaceNoBg,
    99998: SDDiffusionFaceNoBg,
    100430: SDDiffusionFaceNoBg,
    100235: SDDiffusionFaceNoBg,
    101150: SDDiffusionFaceNoBg,
    101578: SDDiffusionFaceNoBg,
    101579: SDDiffusionFaceNoBg,
    101580: SDDiffusionFaceNoBg,
    101581: SDDiffusionFaceNoBg,
    101761: SDDiffusionFaceNoBg,
    102272: SDDiffusionFaceNoBg,
    102273: SDDiffusionFaceNoBg,
    102274: SDDiffusionFaceNoBg,
    102279: SDDiffusionFaceNoBg,
    102510: SDDiffusionFaceNoBg,
    102427: SDDiffusionFaceNoBg,
    102771: SDDiffusionFaceNoBg,
    102774: SDDiffusionFaceNoBg,
    103212: SDDiffusionFaceNoBg,
    102773: SDDiffusionFaceNoBg, 
    102776: SDDiffusionFaceNoBg, 
    102777: SDDiffusionFaceNoBg,
    102778: SDDiffusionFaceNoBg,
    103288: SDDiffusionFace
}
LRS = {
    99826: '1e-4',
    99828: '1e-4',
    99998: '1e-4',
    100430: '1e-4',
    100235: '1e-4',
    101150: '1e-4',
    101578: '5e-5',
    101579: '1e-5',
    101580: '5e-6',
    101581: '1e-6',
    101761: '1e-4',
    102272: '5e-5',
    102273: '1e-5',
    102274: '5e-6',
    102279: '1e-6',
    102510: '1e-4',
    102427: '1e-4',
    102771: '1e-4',
    102774: '1e-4',
    103212: '1e-4',
    102773: '1e-6',
    102776: '5e-5',
    102777: '1e-5',
    102778: '5e-6',
    103288: '1e-4'
}
DIRNAME = {
    99826: CHECKPOINT_FOLDER_NAME,
    99828: CHECKPOINT_FOLDER_NAME,
    99998: CHECKPOINT_FOLDER_NAME,
    100430: CHECKPOINT_FOLDER_NAME,
    100235: CHECKPOINT_FOLDER_NAME,
    101150: CHECKPOINT_FOLDER_NAME,
    101578: CHECKPOINT_FOLDER_NAME,
    101579: CHECKPOINT_FOLDER_NAME,
    101580: CHECKPOINT_FOLDER_NAME,
    101581: CHECKPOINT_FOLDER_NAME,
    101761: CHECKPOINT_FOLDER_NAME,
    102272: CHECKPOINT_FOLDER_NAME,
    102273: CHECKPOINT_FOLDER_NAME,
    102274: CHECKPOINT_FOLDER_NAME,
    102279: CHECKPOINT_FOLDER_NAME,
    102510: CHECKPOINT_FOLDER_NAME,
    102427: CHECKPOINT_FOLDER_NAME,
    102771: CHECKPOINT_FOLDER_NAME,
    102774: CHECKPOINT_FOLDER_NAME,
    103212: CHECKPOINT_FOLDER_NAME,
    102773: CHECKPOINT_FOLDER_NAME,
    102776: CHECKPOINT_FOLDER_NAME, 
    102777: CHECKPOINT_FOLDER_NAME,
    102778: CHECKPOINT_FOLDER_NAME,
    103288: CHECKPOINT_FOLDER_NAME
}
CHECKPOINTS = {
    99826: 20,
    99828: 20,
    99998: 20,
    100430: 90,
    100235: 60,
    101150: 20,
    101578: 98,
    101579: 98,
    101580: 98,
    101581: 98,
    101761: 72,
    102272: 20,
    102273: 20,
    102274: 20,
    102279: 20,
    102510: 150,
    102427: 20,
    102771: 29,
    102774: 20,
    103212: 20,
    102773: 20,
    102776: 20,
    102777: 20,
    102778: 20,
    103288: 29,
}

use_ab_background = []
use_shcoeff2 = []
use_only_light = []
use_no_light = [99826, 99828, 99998, 100430, 100235,101150, 101578, 101579, 101580, 101581, 102272, 102273, 102274, 102279, 102510, 102427, 102771, 102774, 103212, 102773, 102776, 102777, 102778, 103288]
use_random_mask_background = []

def get_from_mode(mode):
    if mode == "v3_copyroom10_rotate_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/val_rotate_copyroom10", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/10n_copyroom10_rotate.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "valid2left":
        return "/data/pakkapon/datasets/face/ffhq_defareli/valid2left", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/face/ffhq_defareli/valid2left/index-array.json"}, "a photorealistic image"
    if mode == "valid2right":
        return "/data/pakkapon/datasets/face/ffhq_defareli/valid2right", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/face/ffhq_defareli/valid2right/index-array.json"}, "a photorealistic image"
    if mode == "valid_face_same":
        return "/data/pakkapon/datasets/face/ffhq_defareli/diffusion-face-relight-testset-same-subject", 862, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/face/ffhq_defareli/diffusion-face-relight-testset-same-subject/index-array.json"}, "a photorealistic image"
    if mode == "valid_face_different":
        return "/data/pakkapon/datasets/face/ffhq_defareli/diffusion-face-relight-testset-different-subject", 200, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/face/ffhq_defareli/diffusion-face-relight-testset-different-subject/index-array.json"}, "a photorealistic image"
    if mode == "face_spatial_guy329":
        return "/data/pakkapon/datasets/face/ffhq_defareli/valid_spatial_guy329", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/face/ffhq_defareli/valid_spatial_guy329/index-array.json", "shadings_dir": "shadings", "backgrounds_dir": "backgrounds", "images_dir":"images" , "feature_types": []},  "a photorealistic image"
    if mode == "face_spatial_guy329_single":
        return "/data/pakkapon/datasets/face/ffhq_defareli/valid_spatial_guy329", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/face/ffhq_defareli/valid_spatial_guy329/index-array-single.json", "shadings_dir": "shadings", "backgrounds_dir": "backgrounds", "images_dir":"images" , "feature_types": []},  "a photorealistic image"
    if mode == "face_spatial":
        return "/data/pakkapon/datasets/face/ffhq_defareli/valid_spatial", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/face/ffhq_defareli/valid_spatial/index-array.json", "shadings_dir": "shadings", "backgrounds_dir": "backgrounds", "images_dir":"images" , "feature_types": []},  "a photorealistic image"
    if mode == "single_14n_copyroom10_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_single_light4.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "single_everett_dining1_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_single_light0.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_14n_copyroom10_light_from_albedo_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light_from_albedo.json", "shadings_dir": "control_shading_from_fitting_v3_exr_for_albedo", "backgrounds_dir": "control_render_from_fitting_v2_for_albedo", "images_dir":"control_render_from_fitting_v2_for_albedo" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_14n_copyroom10_light_from_albedo_oldgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light_from_albedo.json", "shadings_dir": "control_shading_from_fitting_v3_exr_for_albedo", "backgrounds_dir": "control_render_from_fitting_v2_for_albedo", "images_dir":"control_images_from_fitting_v2_for_albedo" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_14n_copyroom10_light0_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_14n_copyroom10_light3_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light3.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_14n_copyroom10_light4_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light4.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_14n_copyroom10_light20_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light20.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_everett_dining1_divide":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr_divide", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_everett_dining1_exr_oldgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_everett_dining1_light20_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all_light20.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_everett_dining1_light4_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all_light4.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_everett_dining1_light3_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all_light3.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_shiftbrightness_to_middle_all_everett_dining1_light3_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all_light3.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "v3_all_everett_dining1_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_dining1_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "all_everett_kitchen4_divide":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_kitchen4_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr_divide", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_everett_kitchen4_exr_oldgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_kitchen4_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_everett_kitchen4_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/test", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/everett_kitchen4_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom1_divide":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom1_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr_divide", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom1_exr_oldgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom1_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom1_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom1_all.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom10_light3_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light3.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom10_light4_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light4.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom10_light20_exr_newgt":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light20.json", "shadings_dir": "control_shading_from_fitting_v3_exr", "backgrounds_dir": "control_render_from_fitting_v2", "images_dir":"control_render_from_fitting_v2" , "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom10_light3_divide":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light3.json", "shadings_dir": "control_shading_from_fitting_v3_exr_divide", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom10_light4_divide":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light4.json", "shadings_dir": "control_shading_from_fitting_v3_exr_divide", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    if mode == "all_14n_copyroom10_light20_divide":
        return "/data/pakkapon/datasets/multi_illumination/spherical/train", 100, DDIMDiffusionFaceRelightDataset,{"index_file":"/data/pakkapon/datasets/multi_illumination/spherical/index/14n_copyroom10_all_light20.json", "shadings_dir": "control_shading_from_fitting_v3_exr_divide", "backgrounds_dir": "images", "feature_types": []},  "a photorealistic image"
    else:
        raise Exception("mode not found")

def main():
    print("STARTING VALIDATION...")
    versions = [int(a.strip()) for a in args.version.split(",")]
    guidance_scales = [float(a.strip()) for a in args.guidance_scale.split(",")]
    #checkpoints = [int(a.strip()) for a in args.checkpoint.split(",")]
    checkpoints = []
    for checkpoint in args.checkpoint.split(","):
        checkpoint = checkpoint.strip()
        try:
            checkpoint = int(checkpoint)
        except:
            pass 
        checkpoints.append(checkpoint)
    modes = [a.strip() for a in args.mode.split(",")]

    print("version: ", versions)
    print("guidance_scales: ", guidance_scales)
    print("checkpoints: ", checkpoints)
    print("modes: ", modes)

    for mode in modes:
        for version in versions:
                ddim_class = CONDITIONS_CLASS[version]
                try:
                    for checkpoint in checkpoints:
                        dirname = DIRNAME[version]
                        if checkpoint == "lastest":
                            checkpoint = CHECKPOINTS[version]
                        if checkpoint == 0:
                            model = ddim_class(learning_rate=1e-4)
                            CKPT_PATH = None
                        else:
                            CKPT_PATH = f"output/{dirname}/multi_mlp_fit/lightning_logs/version_{version}/checkpoints/epoch={checkpoint:06d}.ckpt"
                            if not os.path.exists(CKPT_PATH):
                                print(f"Checkpoint not found: {CKPT_PATH}")
                                continue
                            model = ddim_class.load_from_checkpoint(CKPT_PATH)
                        # disable chromeball inpaint if exist
                        if hasattr(model, 'pipe_chromeball'):
                            del model.pipe_chromeball
                        model.eval() # disable randomness, dropout, etc...
                        model.disable_plot_train_loss()
                        for guidance_scale in guidance_scales:
                            #model.set_guidance_scale(guidance_scale)
                            #model.set_ddim_strength(guidance_scale) #temporary hack to feed the guidance ratio                        
                            #model.set_gaussain_strength(guidance_scale)  #temporary hack to feed the guidance ratio
                            #model.set_ddim_brightness_random(0.4)
                            output_dir = f"output/{FOLDER_NAME}/val_{mode}/{METHODS[version]}/{guidance_scale}/{NAMES[version]}/{LRS[version]}/chk{checkpoint}/"
                            # skip if output dir exist 
                            if os.path.exists(output_dir):
                                print(f"Skip {output_dir}")
                                continue
                            os.makedirs(output_dir, exist_ok=True)
                            print("================================")
                            print(output_dir)
                            print("================================")
                            trainer = L.Trainer(max_epochs=1000, precision=MASTER_TYPE, check_val_every_n_epoch=1, default_root_dir=output_dir, inference_mode=False, gradient_clip_val=0)
                            val_root, count_file, dataset_class, dataset_args, specific_prompt = get_from_mode(mode)
                            if type(count_file) == int:
                                split = slice(0, count_file, 1)
                            else:
                                split = count_file
                            if version in use_shcoeff2:
                                dataset_args['use_shcoeff2'] = True
                            if version in use_only_light:
                                dataset_args['feature_types'] = ['light']
                            if version in use_no_light:
                                dataset_args['feature_types'] = []
                            val_dataset = dataset_class(split=split, root_dir=val_root, specific_prompt=specific_prompt, **dataset_args)
                            val_dataloader = torch.utils.data.DataLoader(val_dataset, batch_size=1, shuffle=False)
                            trainer.test(model, dataloaders=val_dataloader, ckpt_path=CKPT_PATH)


                except Exception as e:
                    raise e

                                
if __name__ == "__main__":
    main()